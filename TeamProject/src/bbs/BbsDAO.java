package bbs;


import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.sql.DataSource;

public class BbsDAO {
	
	// DB ?‘?—… ê°ì²´
	private Connection conn;
	private PreparedStatement pstmt;
	private ResultSet rs;
	
	// ì»¤ë„¥?…˜ ???„ ?‹´?„ ë³??ˆ˜ ?„ ?–¸
	DataSource ds = null;
	
	// ?ƒ?„±?
	public BbsDAO(){
		try {
			// 1. Was?„œë²„ì? ?—°ê²°ëœ ?›¹?”„ë¡œì ?Š¸?˜ ëª¨ë“ ? •ë³´ë?? ê°?ì§?ê³? ?ˆ?Š” ì»¨í…?Š¤?Š¸ ê°ì²´ ?ƒ?„±
			Context init = new InitialContext();
			// 2. ?—°ê²°ëœ Was?„œë²„ì—?„œ DataSource(ì»¤ë„¥?…˜ ??)?„ ê²??ƒ‰?•´?„œ ?–»ê¸?
			ds = (DataSource)init.lookup("java:comp/env/jdbc/BBS");
						
		} catch (Exception e) {
			// TODO: handle exception
			System.out.println("ì»¤ë„¥?…˜?? ê°?? ¸?˜¤ê¸? ?‹¤?Œ¨ : "+e);
		}
	}// ?ƒ?„±? ?
		
	// ë¦¬ì†Œ?Š¤ ë°˜ë‚©(?•´? œ) ë©”ì„œ?“œ
	public void freeResource(){
		if(conn != null){
			try {
				conn.close();
			} catch (Exception e) {
				// TODO: handle exception
				e.printStackTrace();
			}
		}
		if(rs != null){
			try {
				rs.close();
			} catch (Exception e) {
				// TODO: handle exception
				e.printStackTrace();
			}
		}if(pstmt != null){
			try {
				pstmt.close();
			} catch (Exception e) {
				// TODO: handle exception
				e.printStackTrace();
			}
		}
	}
	//?—

	//bd(insert)
	public int insertBbs(String bbsTitle, String bbsContent){
		String SQL = "insert into bbs_p (bbsTitle, bbsContent) values(?,?)";
		try {
			//SQL? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ”ë¸ì˜™ä¸™å ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿?
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			pstmt = conn.prepareStatement(SQL);
			pstmt.setString(1, bbsTitle);
			pstmt.setString(2, bbsContent);
			//rs = pstmt.executeQuery();
			return pstmt.executeUpdate(); //executeUpdate? ?™?˜™ ? ?Œœ?“¸?˜™? ?‹¹ê¸°ë•Œ? ?™?˜™? ?™?˜™ executeQuery? ?™?˜™ ? ?‹­?š¸?˜™? ?™?˜™? ?™?˜™? ?™?˜™? ï¿? 
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		return -1; 
	}
}
	
	
/* 	
	public void closeDB(){
		try {
			if(rs !=null){
				rs.close();
			}
			else if(pstmt != null){
				pstmt.close();
			}
			else if(conn != null){
				conn.close();
			}
			
		} catch (Exception e) {
			// TODO: handle exception
		}
	}
	
	

	
	//? ?™?˜™? ?™?˜™ ? ?‹œê³¤ì˜™
	public String getDate(){
		String SQL = "select now()";
		try {
			//SQL? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ”ë¸ì˜™ä¸™å ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿?
			PreparedStatement pstmt = conn.prepareStatement(SQL);
			rs = pstmt.executeQuery();
			if(rs.next()){
				return rs.getString(1);
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeDB();
		}
		
		
		return ""; //? ?™?˜™? ?™?˜™? ?‹¶ë¸ì˜™? ?‹±?™?˜™ ? ?™?˜™? ?™?˜™
	}
	
	//? ?™?˜™? ?™?˜™ ? ?Œ‰?‹œë±„ì˜™
	public int getNext(){
		String SQL = "select bbsID from bbs_p order by bbsID desc";
		try {
			//SQL? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ”ë¸ì˜™ä¸™å ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿?
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			pstmt = conn.prepareStatement(SQL);
			rs = pstmt.executeQuery();
			if(rs.next()){
				return rs.getInt(1)+1;
			}
			return 1; //ì²«å ?™?˜™ì§? ? ?Œ‰?‹œë±„ì˜™? ?™?˜™ ? ?™?˜™? ï¿?
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeDB();
		}
		
		return -1; //? ?™?˜™? ?™?˜™? ?‹¶ë¸ì˜™? ?‹±?™?˜™ ? ?™?˜™? ?™?˜™
	}

	<insert>
	//? ?Œ‰?‹œê¸??š¸?˜™ ? ?™?˜™è¼‰Ñì˜™? ?™?˜™? ï¿? ?™•? ?™?˜™ ? ?™?˜™? ?™?˜™
	public int insertBbs(String bbsTitle, String bbsContent){
		String SQL = "insert into bbs_p values(?,?,?,?,?,?)";
		try {
			//SQL? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ”ë¸ì˜™ä¸™å ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿?
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			pstmt = conn.prepareStatement(SQL);
			pstmt.setInt(1, 1);
			pstmt.setString(2, bbsTitle);
			pstmt.setString(3, "id"); //id
			pstmt.setString(4, "date"); //datetime
			pstmt.setString(5, bbsContent);
			pstmt.setInt(6, 1); //available
			//rs = pstmt.executeQuery();
			return pstmt.executeUpdate(); //executeUpdate? ?™?˜™ ? ?Œœ?“¸?˜™? ?‹¹ê¸°ë•Œ? ?™?˜™? ?™?˜™ executeQuery? ?™?˜™ ? ?‹­?š¸?˜™? ?™?˜™? ?™?˜™? ?™?˜™? ï¿? 
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeDB();
		}
		
		return -1; //? ?™?˜™? ?™?˜™? ?‹¶ë¸ì˜™? ?‹±?™?˜™ ? ?™?˜™? ?™?˜™
	}
	

	public ArrayList<BbsDTO> getList(int pageNumber){
		//bbsID? ?™?˜™ ?Š¹? ?™?˜™? ?™?˜™? ?Œ˜ë¸ì˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™, ? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™ ? ?‹­?–µ?˜™ 1? ?™?˜™ ? ?Œœ?“¤ë§? ? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™, ? ?™?˜™? ?™?˜™? ?™?˜™ 10? ?™?˜™? ?™?˜™? ?™?˜™
		String SQL = "select * from bbs_p where bbsID < ? and bbsAvailable = 1 order by bbsID desc LIMIT 10";
		//Bbs? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™ ? ?‹¸?™?˜™? ?‹¹?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?‹¹?Œ?˜™ ? ?™?˜™? ?™?˜™?Š¸
		ArrayList<BbsDTO> list = new ArrayList<BbsDTO>();
		try {
			//SQL? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ”ë¸ì˜™ä¸™å ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿?
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			 pstmt = conn.prepareStatement(SQL);
			//getNext: ? ?Œ“?Œ?˜™? ?™?˜™? ?™?˜™ ? ?Œœ?‡½?˜™ ? ?™?˜™ ? ?™?˜™?˜¸
			//? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ‰?‹œê¹ì˜™? ?™?˜™ 5? ?™?˜™? ?™?˜™ ? ?™?˜™? ï¿?, 6? ?™?˜™ ? ?™?˜™? ?™?˜™.  6? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œœ?“¸?˜™ ? ?™?˜™? ï¿? ? ?™?˜™? ?™?˜™? ?™?˜™
			pstmt.setInt(1,  getNext() - (pageNumber -1) * 10);
			rs = pstmt.executeQuery();
			//? ?™?˜™? ?™?˜™? ï¿? ? ?™?˜™? ?‹œ?°?˜™? ?™?˜™? ?™?˜™
			while(rs.next()){
				BbsDTO bbs = new BbsDTO();
				bbs.setBbsID(rs.getInt(1));
				bbs.setBbsTitle(rs.getString(2));
				bbs.setUserID(rs.getString(3));
				bbs.setBbsDate(rs.getString(4));
				bbs.setBbsContent(rs.getString(5));
				bbs.setBbsAvailable(rs.getInt(6));
				list.add(bbs);
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeDB();
		}
		
		return list; //? ?‹±?•„?š¸?˜™ 10? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™?Š¸ ? ?™?˜™? ï¿?
	}
	
	//? ?™?˜™? ?™?˜™ì§? ì²˜å ?™?˜™ (nextPage: ? ?™?˜™? ?™?˜™ì§•å ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?‹¹?Œ?˜™ ? ?Œ‰?‡½?˜™)
	//? ?Œ‰?‹œê¹ì˜™? ?™?˜™ 10? ?™?˜™ ? ?™?˜™ ? ?™?˜™? ï¿?, ? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿? ? ?‹¼?Œ?˜™(? ?™?˜™? ?™?˜™?™”? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™ ? ?‹­ê¸°ë•Œ? ?™?˜™)
	public boolean nextPage(int pageNumber){
		String SQL = "select * from bbs_p where bbsID < ? and bbsAvailable = 1";
		try {
			//SQL? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ”ë¸ì˜™ä¸™å ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿?
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			pstmt = conn.prepareStatement(SQL);
			//getNext: ? ?Œ“?Œ?˜™? ?™?˜™? ?™?˜™ ? ?Œœ?‡½?˜™ ? ?™?˜™ ? ?™?˜™?˜¸
			//? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œ‰?‹œê¹ì˜™? ?™?˜™ 5? ?™?˜™? ?™?˜™ ? ?™?˜™? ï¿?, 6? ?™?˜™ ? ?™?˜™? ?™?˜™.  6? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?Œœ?“¸?˜™ ? ?™?˜™? ï¿? ? ?™?˜™? ?™?˜™? ?™?˜™
			pstmt.setInt(1,  getNext() - (pageNumber -1) * 10);
			rs = pstmt.executeQuery();
			//? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿? 1? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?‹¼?‹¤ëªŒì˜™
			if (rs.next()){
				//? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™ ? ?‹¼?–´ê°? ? ?™?˜™ ? ?™?˜™? ?™?˜™
				return true;
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeDB();
		}
		
		//? ?Œ“ë¤„ì˜™? ?™?˜™ ? ?‹­?‹¤ëªŒì˜™ false
		return false;
	}
	

	public BbsDTO getBbs(int bbsID){ //?Š¹? ?™?˜™ ? ?™?˜™? ?‹±?“¸?˜™? ?™?˜™ ? ?Œ‰?‹œê¹ì˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™
		String SQL = "select * from bbs_p where bbsID = ?"; //bbsID? ?™?˜™ ?? ?˜?– ? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?™?˜™? ï¿?(? ?Œ‰?‹œê¹ì˜™? ?™?˜™ ? ?Œ“?Œ?˜™? ï¿? ? ?™?˜™? ?™?˜™? ?Š¹?Œ?˜™)
		try {
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			pstmt = conn.prepareStatement(SQL);
			pstmt.setInt(1,  bbsID);
			rs = pstmt.executeQuery();
			if (rs.next()){
				//? ?™?˜™ ArrayList? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿? getList? ?™?˜™ ? ?Œ˜?“¸?˜™? ?™?˜™? ï¿? ? ?™?˜™? ?™?˜™? ?™?˜™
/////////////ï¿½ì” å¯ƒê»Šë£? è«›ë¶½?“­ï¿½ë¹ï¿½ë¸¯ï¿½êµ¹? bbs -> bbs_p
				BbsDTO bbs_p = new BbsDTO();
				bbs_p.setBbsID(rs.getInt(1));
				bbs_p.setBbsTitle(rs.getString(2));
				bbs_p.setUserID(rs.getString(3));
				bbs_p.setBbsDate(rs.getString(4));
				bbs_p.setBbsContent(rs.getString(5));
				bbs_p.setBbsAvailable(rs.getInt(6));
				return bbs_p;
				//? ?™?˜™? ?™?˜™? ï¿? ? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™ 6? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™ ? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™ bbs? ?‹¸?™?˜™? ?‹¹?™?˜™? ?™?˜™ ? ?Œ?–µ?˜™ 
				//? ?Œ“?Œ?˜™? ï¿? getBbs? ?Œ‰?‡½?˜™? ?™?˜™ ? ??ë¤„ì˜™? ?™?˜™ ? ?™?˜™?’¨?œå ï¿? ? ?™?˜™?™˜
				}
			} catch (Exception e) {
				e.printStackTrace();
			} finally {
				closeDB();
			}
			
			//? ?Œ”?Œ?˜™? ?™?˜™? ï¿? ? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™ ? ?‹­?‹¤ëªŒì˜™ null? ?™?˜™ ? ?™?˜™?™˜
			return null;
	}
	
	//? ?™?˜™? ?™?˜™? ?™?˜™?Š¸
	public int update(int bbsID, String bbsTitle, String bbsContent){
		String SQL = "update bbs_p set bbsTitle=?, bbsContent=? where bbsID=?";
		try {
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			pstmt = conn.prepareStatement(SQL);
			pstmt.setString(1, bbsTitle);
			pstmt.setString(2, bbsContent);
			pstmt.setInt(3, bbsID);
			return pstmt.executeUpdate(); 
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeDB();
		}
		
		return -1; //? ?™?˜™? ?™?˜™? ?‹¶ë¸ì˜™? ?‹±?™?˜™ ? ?™?˜™? ?™?˜™
	}
	
	//? ?™?˜™? ?™?˜™?Š¸
	public int delete(int bbsID){
		//? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?‹¹?Œ?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ?™?˜™? ?™?˜™ ? ?™?˜™ ? ?Œê³¤ì˜™ Available? ?™?˜™ ? ?™?˜™? ?™?˜™ 0? ?™?˜™? ?™?˜™ ? ?™?˜™? ?™?˜™? ï¿?
		String SQL = "update bbs_p set bbsAvailable = 0 where bbsID=?";
		try {
			//PreparedStatement pstmt = conn.prepareStatement(SQL);
			pstmt = conn.prepareStatement(SQL);

			pstmt.setInt(1, bbsID);
			return pstmt.executeUpdate(); 
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			closeDB();
		}
		
		return -1; //? ?™?˜™? ?™?˜™? ?‹¶ë¸ì˜™? ?‹±?™?˜™ ? ?™?˜™? ?™?˜™
	}

}
*/